# REDIS知识摘录

## 1.redis使用一种自己构建的名为简单动态字符串的抽象类型（SDS）
经过包装之后，sds中保存如下信息，1，字符数组2，已使用的数组长度3，未使用的数组长度
好处如下：
省去了通过遍历才能实现获取字符串长度的方法<br>
redis的五种数据类型：string，hash，set，sortedset，list
string数据类型使用简单动态字符串实现SDS,而不是c默认的字符串
sortedset的实现是使用跳跃表，除此之外，集群的内部数据结构也是跳跃表
set使用整数集合实现(前提：集合中数据都是整数，且数量不多),整数集合中的元素都是有序的
list和hash的底层实现是列表键

## redis的事物及机理
	事物有关的三个命令：multi，exec，watch
multi实现从非事务到事务状态的切换，（这是通过在客户端中的改变REDIS_MULTI状态实现的）
事务状态下除了MULTI，DISCARD，EXEC，WATCH四个命令，其他的命令都会被放入事务队列中

watch命令是乐观锁
redis的事物不支持回滚：即使事务队列中的某个命令在 <font color="red"> 执行期间 </font> 出现了错误，整个事务仍然会继续执行，之前和之后的命令都不会受影响
而 <font color="red"> 入队出错 </font> 时，事务可以放弃执行<br>
redis之所以不支持回滚，是因为，设计者相信这种错误，只会发生在开发期间，不会在生产中出现（既，找不到业务场景）<br>

## redis设置过期时间和生存时间
过期时间：expireat （意为，在指定时间后失效，使用unix时间戳（可以是秒或者毫秒））
生存时间：expire（设置key的存活时长，单位可以是秒或者毫秒）
### 处理过期键删除策略：redis使用定期删除和惰性删除两种策略
惰性删除：在插入或取出键的时候判断过期时间
定期删除：会随机取出一部分，判断是否过期，过期则删除
以上两种方式结合共同实现处理过期键

## redis数据持久化
rdb和aof
redis启动时会判断aof是否开启，开启的话通过aof载入，否则通过rdb载入，如果都没开启，则数据库为空
redis主动关闭的时候会进行持久化<br>
aof持久化：保存的是修改数据库的命令。<br>分为三个步骤：追加，写入，同步<br>
追加：是指将写命令追加至redis缓冲区末尾<br>
写入：<br>
同步：<br>
redis的aof策略，<br>
everysecond:<br>
always<br>
no<br>(这三个都是针对服务器在进行文件处理时，服务器中发生的写操作进行的),这里面的同步计时都是针对上一次发生文件同步而言的
aof:为了避免aof文件过于臃肿，redis会进行aof重写，通过判断数据库的状态，生成相应的写入语句，重新生成aof文件。这个过程叫做aof重写

aof重写会在子进程中进行（子进程与父进程共享资源），为了避免子进程的数据更新不及时，会在创建子进程后，将父进程的命令写入重写缓冲区，子进程在写操作之后，会读取重写缓冲区的内容进行同步。

##redis的数据库
使用select切换数据库redis有0-15号，共16个数据库

##redis的事件
redis使用套接字与客户端或者redis服务器进行通信

##redis的哨兵机制

当主服务器故障时，哨兵会将其中一个从服务器推举为主服务器，将剩余redis设置为该主服务器的从服务器。
如果之前的主服务器重新加入，那么会成为新的主服务器的从服务器。<br>
当启动一个sentinel时，会执行以下步骤<br>
1，初始化服务器<br>
2，将redis服务器代码替换为sentinel专用代码<br>
3，初始化sentinel状态<br>
4，根据给定的配置文件，初始化sentinel监视主服务器列表<br>
5，创建连向主服务器的网络连接<br>
sentinel判断redis下线状态包括两种类型：主观下线和客观下线。<br>
主观下线：当sentinel在连续的设置时间内从主服务器收到无效回复时，即认为是主观下线
客观下线：当sentinel询问其他sentinel服务器时，并且获得了足够数量的主服务器下线的判断（包括主观下线和客观下线）时，即认为是客观下线。此时会通过选举出领头的sentinel对该主服务器执行故障转移操作


